# TCP/IP协议

## 1. 三次握手和四次挥手

### 三次握手

三次握手的作用就是建立客户端和服务端的全双工连接，使得双方能够明确自己和对方的收、发能力是正常的。

第一次握手：client端发送SYN网络包，server端收到，这样server端就能明确client端的发送能力、server端的接收能力是正常的；

第二次握手：server端发送SYN+ACK包，client端收到，这样client端就能够明确server端的接收、发送能力，server端的接收、发送能力四正常的；

第三次握手：client端发送ACK包，server端收到，这样server端就能够明确client端的发送、接收能力正常，server端的接收、发送能力正常；

只有经历上面的三次握手过程，客户端和服务端都能够明确自己的接收、发送能力是正常的的。这样，全双工的通信建立起来。

### 四次挥手

当TCP连接一方要断开时，会发送FIN报文诉对方，这时对方回一个ACK，此时一个方向的连接关闭。但是另一个方向仍然可以传输数据，等到发送完所有数据（CLOSE_WAIT），会发送一个FIN报文来关闭这个方向上的连接。接收方收到FIN报文，会回复ACK，并经历TIME_WAIT的时间关闭连接，对方在收到ACK后会关闭连接，至此，双向连接关闭。

四次挥手比三次握手多一次的原因是在关闭连接的时候，当收到对方的FIN报文时，不能马上回复对方一个FIN报文段，因为结束数据传输的指令时上层应用层给出的，只有应用层数据处理完毕，确认没有数据传输，才会发送FIN报文关闭连接，这个时间也就是CLOSE_WAIT时间。

### TIME_WAIT

1. time_wait如何产生

调用close()发起主动关闭的一方，在发送最后一个ACK之后会进入time_wait状态，也就是说该发送方会保持2MSL的时间才会回到初始状态(MSL时数据包在网络中的最大生存时间)。

2. time_wait的作用

(1)为了实现TCP全双工连接的可靠释放

假设主动关闭的一方(client)最后发送ACK在网络中丢失，由于TCP重传机制，执行被动关闭的一方(server)将会重新发送FIN，在该FIN到达之前，client必须维护这条连接状态，直到另一方重发FIN，这段时间最长不超过2MSL 。如果没有TIME_WAIT，当被动关闭的一方重新发送数据，主动关闭的一方会用RST包响应对方，这会被对方认为是有错误发生，然而只是正常的关闭过程，并非异常。

(2)为了使旧的的数据包在网络中过期消失

如果没有TIME_WAIT，新建立的连接可能会收到上次连接的数据，从而导致数据混乱。

3. 高并发下的time_wait

在高并发连接的TCP服务器上，当服务器处理完请求后关闭连接，这个场景下会出现大量socket处于time_wait状态。如果客户端的并发量持续很高，此时由于服务器socket耗尽，部分客户端可能就会连接不上。

可以编辑linux内核文件/etc/sysctl.conf来尽量处理TIMEWAIT过多的问题

```shell
net.ipv4.tcp_syncookies = 1 表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；
net.ipv4.tcp_tw_reuse = 1 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；
net.ipv4.tcp_tw_recycle = 1 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。
net.ipv4.tcp_fin_timeout 修改系默认的 TIMEOUT 时间
```

## 2. IP地址分类和特殊的IP地址

因特网采用一种全局通用的地址格式，为全网的每一个网络和每一台主机都分配一个IP地址，以此来屏蔽物理网络地址的差异。因特网由网络连接而成，网络由主机连接而成。IP地址由网络号和主机号构成，表示为：IP-adress ::={<Newwork-number>, <Host-number>}，其中网络决定了整个因特网能够容纳多少个网络，主机号的长度决定每个网络能容纳多少台主机。IP定义了五类IP地址：A类、B类、C类、D类和E类。

在IP地址中有一些并不是来标注主机的，这些地址具有特殊的意义。这些地址包括网络地址、直接广播地址、受限广播地址、本地网络地址、环回地址。

### 网络地址

因特网的每个网络都有一个IP地址，其主机号部分为0。eg：A类的网络地址：120.0.0.0

### 直接广播地址

直接广播地址是向某个网络上所有的主机发送报文，TCP/IP规定，主机号各位全部为“1”的IP地址用于广播，称做广播地址。eg：A类的网络的直接广播地址为120.255.255.255

### 受限广播地址

直接广播要求发送方必须知道接收的网络号。但有些主机在启动时，往往不知道本网络的网络号，这时候如果想要向本网络广播，只能采用受限广播地址。受限广播地址是在本网络内部进行广播的一种广播地址。TCP/IP规定，32比特全为“1”的IP地址用于本网络内的广播。eg：255.255.255.255

### 本网络地址

TCP/IP协议规定，网络号各位全为0时表示的是本网络。本网络地址分为两种情况：本网络特定主机地址和本网络本主机地址。

本网络特定主机地址的表达式为：{<NetWork-Number>,<Host-Number>}={0,<Host-Number>}

本网络本主机地址的表达式为：{<NetWork-Number>,<Host-Number>}={0,0}

### 环回地址

环回地址(loopback Adress)是用于网络软件测试以及本机进程之间通信的特殊地址。